/*
 Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function J(a,b,d){return l(b)&&l(d)&&d.equals(b.getNext(function(a){return!(w(a)||x(a)||n(a))}))}function s(a){this.upper=a[0];this.lower=a[1];this.set.apply(this,a.slice(2))}function K(a){var b=a.element,d;return b&&l(b)?(d=b.getAscendant(a.triggers,!0))&&!d.contains(a.editable)&&!d.equals(a.editable)?d:null:null}function Z(a,b,d){m(a,b);m(a,d);a=b.size.bottom;d=d.size.top;return a&&d?0|(a+d)/2:a||d}function L(a,b,d){return b=b[d?"getPrevious":"getNext"](function(e){return e&&e.type==
CKEDITOR.NODE_TEXT&&!w(e)||l(e)&&!n(e)&&!t(a,e)})}function $(a){var b=a.doc,d=y('<span contenteditable="false" style="'+E+"position:absolute;border-top:1px dashed "+a.boxColor+'"></span>',b);o(d,{attach:function(){this.wrap.getParent()||this.wrap.appendTo(a.editable,!0);return this},lineChildren:[o(y('<span title="'+a.editor.lang.magicline.title+'" contenteditable="false">&#8629;</span>',b),{base:E+"height:17px;width:17px;"+(a.rtl?"left":"right")+":17px;background:url("+this.path+"images/icon.png) center no-repeat "+
a.boxColor+";cursor:pointer;"+(p.hc?"font-size: 15px;line-height:14px;border:1px solid #fff;text-align:center;":""),looks:["top:-8px;"+CKEDITOR.tools.cssVendorPrefix("border-radius","2px",1),"top:-17px;"+CKEDITOR.tools.cssVendorPrefix("border-radius","2px 2px 0px 0px",1),"top:-1px;"+CKEDITOR.tools.cssVendorPrefix("border-radius","0px 0px 2px 2px",1)]}),o(y(M,b),{base:N+"left:0px;border-left-color:"+a.boxColor+";",looks:["border-width:8px 0 8px 8px;top:-8px","border-width:8px 0 0 8px;top:-8px","border-width:0 0 8px 8px;top:0px"]}),
o(y(M,b),{base:N+"right:0px;border-right-color:"+a.boxColor+";",looks:["border-width:8px 8px 8px 0;top:-8px","border-width:8px 8px 0 0;top:-8px","border-width:0 8px 8px 0;top:0px"]})],detach:function(){this.wrap.getParent()&&this.wrap.remove();return this},mouseNear:function(){m(a,this);var e=a.holdDistance,b=this.size;return b&&a.mouse.y>b.top-e&&a.mouse.y<b.bottom+e&&a.mouse.x>b.left-e&&a.mouse.x<b.right+e?!0:!1},place:function(){var b=a.view,d=a.editable,c=a.trigger,h=c.upper,i=c.lower,j=h||i,
k=j.getParent(),g={};this.trigger=c;h&&m(a,h,!0);i&&m(a,i,!0);m(a,k,!0);a.inInlineMode&&z(a,!0);k.equals(d)?(g.left=b.scroll.x,g.right=-b.scroll.x,g.width=""):(g.left=j.size.left-j.size.margin.left+b.scroll.x-(a.inInlineMode?b.editable.left+b.editable.border.left:0),g.width=j.size.outerWidth+j.size.margin.left+j.size.margin.right+b.scroll.x,g.right="");h&&i?g.top=h.size.margin.bottom===i.size.margin.top?0|h.size.bottom+h.size.margin.bottom/2:h.size.margin.bottom<i.size.margin.top?h.size.bottom+h.size.margin.bottom:
h.size.bottom+h.size.margin.bottom-i.size.margin.top:h?i||(g.top=h.size.bottom+h.size.margin.bottom):g.top=i.size.top-i.size.margin.top;c.is(u)||g.top>b.scroll.y-15&&g.top<b.scroll.y+5?(g.top=a.inInlineMode?0:b.scroll.y,this.look(u)):c.is(v)||g.top>b.pane.bottom-5&&g.top<b.pane.bottom+15?(g.top=a.inInlineMode?b.editable.height+b.editable.padding.top+b.editable.padding.bottom:b.pane.bottom-1,this.look(v)):(a.inInlineMode&&(g.top-=b.editable.top+b.editable.border.top),this.look(q));a.inInlineMode&&
(g.top--,g.top+=b.editable.scroll.top,g.left+=b.editable.scroll.left);for(var O in g)g[O]=CKEDITOR.tools.cssLength(g[O]);this.setStyles(g)},look:function(a){if(this.oldLook!=a){for(var b=this.lineChildren.length,c;b--;)(c=this.lineChildren[b]).setAttribute("style",c.base+c.looks[0|a/2]);this.oldLook=a}},wrap:new F("span",a.doc)});for(b=d.lineChildren.length;b--;)d.lineChildren[b].appendTo(d);d.look(q);d.appendTo(d.wrap);d.unselectable();d.setOpacity(a.editor.config.magicline_opacity||1);d.lineChildren[0].on("mouseup",
function(b){d.detach();P(a,function(b){var c=a.line.trigger;b[c.is(A)?"insertBefore":"insertAfter"](c.is(A)?c.lower:c.upper)});a.editor.focus();!p.ie&&a.enterMode!=CKEDITOR.ENTER_BR&&a.hotNode.scrollIntoView();b.data.preventDefault(!0)});d.on("mousedown",function(a){a.data.preventDefault(!0)});a.line=d}function P(a,b){var d=new CKEDITOR.dom.range(a.doc),e=a.editor,f;p.ie&&a.enterMode==CKEDITOR.ENTER_BR?f=a.doc.createText(G):(f=new F(a.enterBehavior,a.doc),a.enterMode!=CKEDITOR.ENTER_BR&&a.doc.createText(G).appendTo(f));
e.fire("saveSnapshot");b(f);d.moveToPosition(f,CKEDITOR.POSITION_AFTER_START);e.getSelection().selectRanges([d]);a.hotNode=f;e.fire("saveSnapshot")}function t(a,b){if(!b||!(b.type==CKEDITOR.NODE_ELEMENT&&b.$))return!1;var d=a.line;return d.wrap.equals(b)||d.wrap.contains(b)}function l(a){return a&&a.type==CKEDITOR.NODE_ELEMENT&&a.$}function n(a){if(!l(a))return!1;var b;if(!(b=Q(a)))l(a)?(b={left:1,right:1,center:1},b=!(!b[a.getComputedStyle("float")]&&!b[a.getAttribute("align")])):b=!1;return b}function Q(a){return!!{absolute:1,
fixed:1,relative:1}[a.getComputedStyle("position")]}function B(a,b){return l(b)?b.is(a.triggers):null}function aa(a,b,d){b=b[d?"getLast":"getFirst"](function(b){return a.isRelevant(b)&&!b.is(ba)});if(!b)return!1;m(a,b);return d?b.size.top>a.mouse.y:b.size.bottom<a.mouse.y}function R(a){var b=a.editable,d=a.mouse,e=a.view,f=a.triggerOffset;z(a);var c=d.y>(a.inInlineMode?e.editable.top+e.editable.height/2:Math.min(e.editable.height,e.pane.height)/2),b=b[c?"getLast":"getFirst"](function(a){return!(w(a)||
x(a))});if(!b)return null;t(a,b)&&(b=a.line.wrap[c?"getPrevious":"getNext"](function(a){return!(w(a)||x(a))}));if(!l(b)||n(b)||!B(a,b))return null;m(a,b);return!c&&0<=b.size.top&&0<d.y&&d.y<b.size.top+f?(a=a.inInlineMode||0===e.scroll.y?u:q,new s([null,b,A,C,a])):c&&b.size.bottom<=e.pane.height&&d.y>b.size.bottom-f&&d.y<e.pane.height?(a=a.inInlineMode||b.size.bottom>e.pane.height-f&&b.size.bottom<e.pane.height?v:q,new s([b,null,S,C,a])):null}function T(a){var b=a.mouse,d=a.view,e=a.triggerOffset,
f=K(a);if(!f)return null;m(a,f);var e=Math.min(e,0|f.size.outerHeight/2),c=[],h,i;if(b.y>f.size.top-1&&b.y<f.size.top+e)i=!1;else if(b.y>f.size.bottom-e&&b.y<f.size.bottom+1)i=!0;else return null;if(n(f)||aa(a,f,i)||f.getParent().is(U))return null;var j=L(a,f,!i);if(j){if(j&&j.type==CKEDITOR.NODE_TEXT)return null;if(l(j)){if(n(j)||!B(a,j)||j.getParent().is(U))return null;c=[j,f][i?"reverse":"concat"]().concat([H,C])}}else f.equals(a.editable[i?"getLast":"getFirst"](a.isRelevant))?(z(a),i&&b.y>f.size.bottom-
e&&b.y<d.pane.height&&f.size.bottom>d.pane.height-e&&f.size.bottom<d.pane.height?h=v:0<b.y&&b.y<f.size.top+e&&(h=u)):h=q,c=[null,f][i?"reverse":"concat"]().concat([i?S:A,C,h,f.equals(a.editable[i?"getLast":"getFirst"](a.isRelevant))?i?v:u:q]);return 0 in c?new s(c):null}function I(a,b,d,e){for(var f=function(){var c=p.ie?b.$.currentStyle:a.win.$.getComputedStyle(b.$,"");return p.ie?function(a){return c[CKEDITOR.tools.cssStyleToDomStyle(a)]}:function(a){return c.getPropertyValue(a)}}(),c=b.getDocumentPosition(),
h={},i={},j={},k={},g=r.length;g--;)h[r[g]]=parseInt(f("border-"+r[g]+"-width"),10)||0,j[r[g]]=parseInt(f("padding-"+r[g]),10)||0,i[r[g]]=parseInt(f("margin-"+r[g]),10)||0;(!d||e)&&D(a,e);k.top=c.y-(d?0:a.view.scroll.y);k.left=c.x-(d?0:a.view.scroll.x);k.outerWidth=b.$.offsetWidth;k.outerHeight=b.$.offsetHeight;k.height=k.outerHeight-(j.top+j.bottom+h.top+h.bottom);k.width=k.outerWidth-(j.left+j.right+h.left+h.right);k.bottom=k.top+k.outerHeight;k.right=k.left+k.outerWidth;a.inInlineMode&&(k.scroll=
{top:b.$.scrollTop,left:b.$.scrollLeft});return o({border:h,padding:j,margin:i,ignoreScroll:d},k,!0)}function m(a,b,d){if(!l(b))return b.size=null;if(b.size){if(b.size.ignoreScroll==d&&b.size.date>new Date-V)return null}else b.size={};return o(b.size,I(a,b,d),{date:+new Date},!0)}function z(a,b){a.view.editable=I(a,a.editable,b,!0)}function D(a,b){a.view||(a.view={});var d=a.view;if(b||!(d&&d.date>new Date-V)){var e=a.win,d=e.getScrollPosition(),e=e.getViewPaneSize();o(a.view,{scroll:{x:d.x,y:d.y,
width:a.doc.$.documentElement.scrollWidth-e.width,height:a.doc.$.documentElement.scrollHeight-e.height},pane:{width:e.width,height:e.height,bottom:e.height+d.y},date:+new Date},!0)}}function ca(a,b,d,e){for(var f=e,c=e,h=0,i=!1,j=!1,k=a.view.pane.height,g=a.mouse;g.y+h<k&&0<g.y-h;){i||(i=b(f,e));j||(j=b(c,e));!i&&0<g.y-h&&(f=d(a,{x:g.x,y:g.y-h}));!j&&g.y+h<k&&(c=d(a,{x:g.x,y:g.y+h}));if(i&&j)break;h+=2}return new s([f,c,null,null])}CKEDITOR.plugins.add("magicline",{lang:"en,pl",init:function(a){var b=
{};b[CKEDITOR.ENTER_BR]="br";b[CKEDITOR.ENTER_P]="p";b[CKEDITOR.ENTER_DIV]="div";var d=a.config,e=d.magicline_triggerOffset||30,f=d.enterMode,c={editor:a,enterBehavior:b[f],enterMode:f,triggerOffset:e,holdDistance:0|e*(d.magicline_holdDistance||0.5),boxColor:d.magicline_color||"#ff0000",rtl:"rtl"==d.contentsLangDirection,triggers:d.magicline_everywhere?CKEDITOR.dtd.$block:{table:1,hr:1,div:1,ul:1,ol:1,dl:1}},h,i,j,k;c.isRelevant=function(a){return l(a)&&!t(c,a)&&!n(a)};a.on("contentDom",function(){var b=
a.editable(),d=a.document,e=a.window;o(c,{editable:b,inInlineMode:b.isInline(),doc:d,win:e},!0);c.boundary=c.inInlineMode?c.editable:c.doc.getDocumentElement();b.is(CKEDITOR.dtd.$inline)||(c.inInlineMode&&!Q(b)&&b.setStyles({position:"relative",top:null,left:null}),$.call(this,c),D(c),b.attachListener(a,"beforeUndoImage",function(){c.line.detach()}),b.attachListener(a,"beforeGetData",function(){c.line.wrap.getParent()&&(c.line.detach(),a.once("getData",function(){c.line.attach()},null,null,1E3))},
null,null,0),b.attachListener(c.inInlineMode?d:d.getWindow().getFrame(),"mouseout",function(b){if("wysiwyg"==a.mode)if(clearTimeout(i),c.inInlineMode){var d=b.data.$.clientX,b=b.data.$.clientY;D(c);z(c,!0);var e=c.view.editable,f=c.view.scroll;if(!(d>e.left-f.x&&d<e.right-f.x)||!(b>e.top-f.y&&b<e.bottom-f.y))clearTimeout(k),k=null,c.line.detach()}else clearTimeout(k),k=null,i=CKEDITOR.tools.setTimeout(c.line.detach,150,c.line)}),b.attachListener(b,"keyup",function(){c.hiddenMode=0}),b.attachListener(b,
"keydown",function(b){if("wysiwyg"==a.mode)switch(b=b.data.getKeystroke(),a.getSelection().getStartElement(),b){case 2228240:case 16:c.hiddenMode=1,c.line.detach()}}),b.attachListener(c.inInlineMode?b:d,"mousemove",function(b){clearTimeout(i);j=!0;if(!("wysiwyg"!=a.mode||k)){var d={x:b.data.$.clientX,y:b.data.$.clientY};k=setTimeout(function(){c.mouse=d;k=c.trigger=null;D(c);if(j&&!c.hiddenMode&&a.focusManager.hasFocus&&!c.line.mouseNear()&&(c.element=W(c,!0)))(c.trigger=R(c)||T(c)||X(c))?c.line.attach().place():
(c.trigger=null,c.line.detach()),j=!1},30)}}),b.attachListener(e,"scroll",function(){"wysiwyg"==a.mode&&(c.line.detach(),p.webkit&&(c.hiddenMode=1,clearTimeout(h),h=setTimeout(function(){c.hiddenMode=0},50)))}),b.attachListener(e,"mousedown",function(){"wysiwyg"==a.mode&&(c.line.detach(),c.hiddenMode=1)}),b.attachListener(e,"mouseup",function(){c.hiddenMode=0}),this.backdoor={accessFocusSpace:P,boxTrigger:s,isLine:t,getAscendantTrigger:K,getNonEmptyNeighbour:L,getSize:I,that:c,triggerEdge:T,triggerEditable:R,
triggerExpand:X})},this)}});var A=128,S=64,H=32,C=16,Y=8,u=4,v=2,q=1,G=" ",U=CKEDITOR.dtd.$listItem,ba=CKEDITOR.dtd.$tableContent,V=100,E="width:0px;height:0px;padding:0px;margin:0px;display:block;z-index:9999;color:#fff;position:absolute;font-size: 0px;line-height:0px;",N=E+"border-color:transparent;display:block;border-style:solid;",M="<span>"+G+"</span>",o=CKEDITOR.tools.extend,F=CKEDITOR.dom.element,y=F.createFromHtml,p=CKEDITOR.env;s.prototype={set:function(a,b,d){this.properties=a+b+(d||q);
return this},is:function(a){return(this.properties&a)==a}};var W=function(){return function(a,b,d){if(!a.mouse)return null;var e=a.doc,f=a.line.wrap,d=d||a.mouse,c=new CKEDITOR.dom.element(e.$.elementFromPoint(d.x,d.y));b&&t(a,c)&&(f.hide(),c=new CKEDITOR.dom.element(e.$.elementFromPoint(d.x,d.y)),f.show());return!c||!(c.type==CKEDITOR.NODE_ELEMENT&&c.$)||p.ie&&9>p.version&&!a.boundary.equals(c)&&!a.boundary.contains(c)?null:c}}(),w=CKEDITOR.dom.walker.whitespaces(),x=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_COMMENT),
X=function(){function a(a){var e=a.element,f,c,h;if(!l(e)||e.contains(a.editable))return null;h=ca(a,function(a,b){return!b.equals(a)},function(a,b){return W(a,!0,b)},e);f=h.upper;c=h.lower;if(J(a,f,c))return h.set(H,Y);if(f&&e.contains(f))for(;!f.getParent().equals(e);)f=f.getParent();else f=e.getFirst(function(c){return b(a,c)});if(c&&e.contains(c))for(;!c.getParent().equals(e);)c=c.getParent();else c=e.getLast(function(c){return b(a,c)});if(!f||!c)return null;m(a,f);m(a,c);if(!(a.mouse.y>f.size.top&&
a.mouse.y<c.size.bottom))return null;for(var e=Number.MAX_VALUE,i,j,k,g;c&&!c.equals(f)&&(j=f.getNext(a.isRelevant));)i=Math.abs(Z(a,f,j)-a.mouse.y),i<e&&(e=i,k=f,g=j),f=j,m(a,f);if(!k||!g||!(a.mouse.y>k.size.top&&a.mouse.y<g.size.bottom))return null;h.upper=k;h.lower=g;return h.set(H,Y)}function b(a,b){return!(b&&b.type==CKEDITOR.NODE_TEXT||x(b)||n(b)||t(a,b)||b.type==CKEDITOR.NODE_ELEMENT&&b.$&&b.is("br"))}return function(b){var e=a(b),f;if(f=e){f=e.upper;var c=e.lower;f=!f||!c||n(c)||n(f)||c.equals(f)||
f.equals(c)||c.contains(f)||f.contains(c)?!1:B(b,f)&&B(b,c)&&J(b,f,c)?!0:!1}return f?e:null}}(),r=["top","left","right","bottom"]})();